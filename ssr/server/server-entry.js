import{defineComponent as C,onMounted as R,resolveComponent as I,useSSRContext as N,getCurrentInstance as U,h as H,markRaw as A,createApp as E,unref as D}from"vue";import{LocalStorage as l,Quasar as F}from"quasar";import{ssrRenderComponent as L}from"vue/server-renderer";import{defineStore as q,createPinia as M}from"pinia";import{store as P,route as $}from"quasar/wrappers/index.mjs";import{createRouter as J,createMemoryHistory as Y}from"vue-router";var a=(e=>(e.BTCUSDT="BTCUSDT",e.BNBBTC="BNBBTC",e.ETHBTC="ETHBTC",e))(a||{});const b={[a.BNBBTC]:{value:a.BNBBTC,label:"BNB/BTC",currencies:{base:"BNB",quoted:"BTC"}},[a.BTCUSDT]:{value:a.BTCUSDT,label:"BTC/USDT",currencies:{base:"BTC",quoted:"USDT"}},[a.ETHBTC]:{value:a.ETHBTC,label:"ETH/BTC",currencies:{base:"ETH",quoted:"BTC"}}},Q=[{label:b[a.BNBBTC].label,value:a.BNBBTC},{label:b[a.BTCUSDT].label,value:a.BTCUSDT},{label:b[a.ETHBTC].label,value:a.ETHBTC}],B="changeSymbolsHistory",y="currentCurrencySymbol";class O{static stream(s="bnbbtc"){return`wss://stream.binance.com:9443/ws/${s}@depth`}static depthSnapshot(s="BNBBTC",t=1e3){return`https://api.binance.com/api/v3/depth?symbol=${s}&limit=${t}`}}const W={async getOrdersStream(e){const s=e.toLowerCase(),t=new WebSocket(O.stream(s));return t.onopen=()=>{console.log("ws open")},t},async getDepthSnapshot(e,s=1e3){return(await fetch(O.depthSnapshot(e,s))).json()}},g={binance:W},x={ordersFromRaw(e){return e.map(s=>{const t=Number(s[0]),o=Number(s[1]),r=Number((t*o).toFixed(8));return{price:t,quantity:o,total:r}})}},m={dataMapping:x},G=q("currency-symbol",{state:()=>({currencySymbol:a.BTCUSDT,symbolsHistory:[],asksOrders:[],bidsOrders:[],lastUpdateId:0,limit:1e3,loading:!1,socket:null}),getters:{getCurrencySymbolView(e){return Q.find(s=>s.value===e.currencySymbol)},getLimitedOrdersList(e){return s=>{let t=[],o=[];return e.asksOrders.length<s?t=e.asksOrders:t=e.asksOrders.slice(0,s),e.bidsOrders.length<s?o=e.bidsOrders:o=e.bidsOrders.slice(0,s),{asks:t,bids:o}}}},actions:{async initState(){this.symbolsHistory=JSON.parse(l.getItem(B))||[],this.currencySymbol=l.getItem(y)||a.BTCUSDT,await this.fetchDepthSnapshot(this.currencySymbol,this.limit)},addLog(e,s){const t={from:e,to:s,date:new Date().toISOString()};this.symbolsHistory.unshift(t),l.setItem(B,JSON.stringify(this.symbolsHistory)),l.setItem(y,s)},async rest(e){this.addLog(this.currencySymbol,e),this.currencySymbol=e,l.setItem(y,e),await this.fetchDepthSnapshot(e,this.limit)},async createOrdersStream(e){this.socket&&this.socket.close(),this.socket=await g.binance.getOrdersStream(e),this.socket.onmessage=s=>{try{const t=JSON.parse(s.data),o=m.dataMapping.ordersFromRaw(t.a),r=m.dataMapping.ordersFromRaw(t.b),c=Number(t.u),i=Number(t.U),h=o.filter(d=>d.quantity!==0),p=r.filter(d=>d.quantity!==0);console.log("U: ",i),c>this.lastUpdateId&&(this.asksOrders.unshift(...h),this.bidsOrders.unshift(...p),this.asksOrders.splice(this.limit),this.bidsOrders.splice(this.limit))}catch{throw new Error("Не удалось получить данные по websocket")}}},async fetchDepthSnapshot(e,s){this.loading=!0;const t=await g.binance.getDepthSnapshot(e,s),o=t.asks,r=t.bids,c=m.dataMapping.ordersFromRaw(o),i=m.dataMapping.ordersFromRaw(r);this.asksOrders=c,this.bidsOrders=i,this.lastUpdateId=t.lastUpdateId,this.loading=!1,await this.createOrdersStream(e)},async resetStream(){this.asksOrders=[],this.bidsOrders=[],await this.createOrdersStream(this.currencySymbol)}}}),_=C({name:"App",__name:"App",__ssrInlineRender:!0,setup(e){const s=G();return R(()=>{s.initState()}),(t,o,r,c)=>{const i=I("router-view");o(L(i,c,null,r))}}}),V=(e,s)=>{const t=e.__vccOpts||e;for(const[o,r]of s)t[o]=r;return t},w=_.setup;_.setup=(e,s)=>{const t=N();return(t.modules||(t.modules=new Set)).add("src/App.vue"),w?w(e,s):void 0};const u=V(_,[["__file","App.vue"]]),S=P(()=>M()),z=[{path:"/",component:()=>import("./assets/MainLayout-14vrFSlY.js"),children:[{path:"",redirect:"/order-book"},{path:"/order-book",component:()=>import("./assets/order-book.page-MmgCr8wc.js")},{path:"/settings",component:()=>import("./assets/settings.page-D7MhUCW-.js")}]},{path:"/:catchAll(.*)*",component:()=>import("./assets/error-not-found.page-BRwFZjJx.js")}],T=$(function(){return J({scrollBehavior:()=>({left:0,top:0}),routes:z,history:Y("/")})}),K=C({name:"AppWrapper",setup(e){return R(()=>{const{proxy:{$q:s}}=U();s.onSSRHydrated!==void 0&&s.onSSRHydrated()}),()=>H(u,e)}});async function X(e,s,t){const o=e(K);o.use(F,s,t);const r=typeof S=="function"?await S({ssrContext:t}):S;o.use(r),typeof window<"u"&&window.__INITIAL_STATE__!==void 0&&(r.state.value=window.__INITIAL_STATE__,delete window.__INITIAL_STATE__);const c=A(typeof T=="function"?await T({ssrContext:t,store:r}):T);return r.use(({store:i})=>{i.router=c}),{app:o,store:r,router:c}}const Z={config:{}},v=typeof u.preFetch=="function"?u.preFetch:u.__c!==void 0&&typeof u.__c.preFetch=="function"?u.__c.preFetch:!1,j="/",ee=/^https?:\/\//;function te(e,s){if(typeof e=="string"&&ee.test(e)===!0)return e;try{return s.resolve(e).href}catch{}return e}const{components:pe,directives:de,...se}=Z,ue=e=>new Promise(async(s,t)=>{const{app:o,router:r,store:c}=await X(E,se,e);o.use(r);const i=e.req.url,{fullPath:h}=r.resolve(i);if(h!==i)return t({url:h});r.push(i).catch(()=>{}),r.isReady().then(()=>{let p=r.currentRoute.value.matched.filter(n=>n.components!==void 0).flatMap(n=>Object.values(n.components));if(p.length===0)return t({code:404});let d=!1;const k=(n,f)=>{d=!0,t({url:te(n,r),code:f})};p=p.filter(n=>typeof n.preFetch=="function"||n.__c!==void 0&&typeof n.__c.preFetch=="function").map(n=>n.__c!==void 0?n.__c.preFetch:n.preFetch),v!==!1&&p.unshift(v),p.reduce((n,f)=>n.then(()=>d===!1&&f({store:c,ssrContext:e,currentRoute:r.currentRoute.value,redirect:k,urlPath:e.req.url,publicPath:j})),Promise.resolve()).then(()=>{d!==!0&&(e.state=D(c.state),s(o))}).catch(t)}).catch(t)});export{a as C,V as _,Q as a,ue as default,b as s,G as u};
